{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - {{ course.name }}{% endblock %}

{% block extra_css %}
<style>
.form-label {
    font-weight: 500;
    color: #333;
}
.card {
    border: none;
    border-radius: 10px;
}
.btn-success {
    background-color: #24b10b;
    border: none;
    padding: 12px;
    font-weight: 500;
    margin-top: 20px;
}
.btn-success:hover {
    background-color: #1e9609;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5" style="margin-top: 80px;">
    <div class="row">
        <!-- Billing Details Form -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="mb-4">Billing Details</h2>
                    <form id="checkout-form" method="POST">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Street address *</label>
                            <input type="text" class="form-control" id="address" name="address" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="city" class="form-label">Town / City *</label>
                                <input type="text" class="form-control" id="city" name="city" required>
                            </div>
                            <div class="col-md-6">
                                <label for="state" class="form-label">State *</label>
                                <select class="form-select" id="state" name="state" required>
                                    <option value="">Select State</option>
                                    <option value="AP">Andhra Pradesh</option>
                                    <option value="AR">Arunachal Pradesh</option>
                                    <option value="AS">Assam</option>
                                    <option value="BR">Bihar</option>
                                    <option value="CT">Chhattisgarh</option>
                                    <option value="GA">Goa</option>
                                    <option value="GJ">Gujarat</option>
                                    <option value="HR">Haryana</option>
                                    <option value="HP">Himachal Pradesh</option>
                                    <option value="JK">Jammu and Kashmir</option>
                                    <option value="JH">Jharkhand</option>
                                    <option value="KA">Karnataka</option>
                                    <option value="KL">Kerala</option>
                                    <option value="MP">Madhya Pradesh</option>
                                    <option value="MH">Maharashtra</option>
                                    <option value="MN">Manipur</option>
                                    <option value="ML">Meghalaya</option>
                                    <option value="MZ">Mizoram</option>
                                    <option value="NL">Nagaland</option>
                                    <option value="OR">Odisha</option>
                                    <option value="PB">Punjab</option>
                                    <option value="RJ">Rajasthan</option>
                                    <option value="SK">Sikkim</option>
                                    <option value="TN">Tamil Nadu</option>
                                    <option value="TG">Telangana</option>
                                    <option value="TR">Tripura</option>
                                    <option value="UT">Uttarakhand</option>
                                    <option value="UP">Uttar Pradesh</option>
                                    <option value="WB">West Bengal</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="zip" class="form-label">ZIP Code *</label>
                            <input type="text" class="form-control" id="zip" name="zip" required>
                        </div>
                        <div class="mb-3">
                            <label for="order_notes" class="form-label">Order notes (optional)</label>
                            <textarea class="form-control" id="order_notes" name="order_notes" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100" id="proceed-btn">Proceed to Payment</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="mb-4">Order Summary</h3>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Product</span>
                        <span>Subtotal</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>{{ course.name }}</span>
                        <span>₹{{ course.discounted_price }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-0">
                        <span class="fw-bold">Total</span>
                        <span class="fw-bold">₹{{ course.discounted_price }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkoutForm = document.getElementById('checkout-form');
    const submitBtn = document.getElementById('proceed-btn');
    
    if (!checkoutForm || !submitBtn) {
        console.error('Required elements not found');
        return;
    }
    
    function resetButton() {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Proceed to Payment';
    }

    // Read CSRF token from cookies (works reliably for AJAX POSTs)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function showError(message) {
        console.error('Error:', message);
        alert('Error: ' + message);
        resetButton();
    }
    
    checkoutForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        try {
            // Convert form data to an object
            const formData = new FormData(e.target);
            const formDataObj = {};
            formData.forEach((value, key) => formDataObj[key] = value);
            
            // Validate form data
            const requiredFields = ['first_name', 'last_name', 'email', 'phone', 'address', 'city', 'state', 'zip'];
            for (const field of requiredFields) {
                if (!formDataObj[field]) {
                    throw new Error(`Please fill in the ${field.replace('_', ' ')}`);
                }
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Create order
            const csrfToken = getCookie('csrftoken');
            const orderResponse = await fetch('{% url "create_order" course.slug %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken || ''
                },
                body: JSON.stringify(formDataObj)
            });
            
            if (!orderResponse.ok) {
                const contentType = orderResponse.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await orderResponse.json();
                    throw new Error(errorData.error || 'Failed to create order');
                }
                throw new Error('Failed to create order');
            }
            
            const data = await orderResponse.json();
            console.log('Order created:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (!data.key || !data.amount || !data.currency || !data.id) {
                throw new Error('Invalid order data received');
            }
            
            // Configure Razorpay options
            const options = {
                key: data.key,
                amount: data.amount,
                currency: data.currency,
                name: "{{ course.name }}",
                description: "Course Purchase",
                order_id: data.id,
                handler: async function (response) {
                    if (!response.razorpay_payment_id || !response.razorpay_order_id || !response.razorpay_signature) {
                        showError('Invalid payment response');
                        return;
                    }
                    
                    console.log('Payment successful:', response);
                    
                    try {
                        const csrfToken2 = getCookie('csrftoken');
                        const callbackResponse = await fetch('{% url "payment_callback" course.slug %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken2 || ''
                            },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature
                            })
                        });
                        
                        if (!callbackResponse.ok) {
                            throw new Error('Payment verification failed');
                        }
                        
                        const callbackData = await callbackResponse.json();
                        if (callbackData.status === 'success') {
                            // Redirect to the my_purchase page after successful payment
                            window.location.href = callbackData.redirect_url || '{% url "my-purchase" %}';
                        } else {
                            throw new Error(callbackData.error || 'Payment verification failed');
                        }
                    } catch (error) {
                        showError(error.message);
                    }
                },
                prefill: {
                    name: `${formDataObj.first_name} ${formDataObj.last_name}`.trim(),
                    email: formDataObj.email,
                    contact: formDataObj.phone
                },
                theme: {
                    color: "#24b10b"
                },
                modal: {
                    ondismiss: resetButton
                }
            };
            
            console.log('Opening Razorpay with options:', options);
            const rzp = new Razorpay(options);
            rzp.on('payment.failed', function(resp) {
                showError(resp.error.description || 'Payment failed');
            });
            rzp.open();
            
        } catch (error) {
            showError(error.message);
        }
    });
});
                </script>
{% endblock %}